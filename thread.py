
import csv
from google_images_download import google_images_download
response = google_images_download.googleimagesdownload() 
import os
import shutil
import shutil
import logging
import threading,random

logging.basicConfig(level=logging.DEBUG,
                    format='[%(levelname)s] (%(threadName)-10s) %(message)s',
                    )
NUM_THREADS = 100

profinal = ['119.42.115.122:8213','136.243.47.220:3128','109.86.229.189:8080','104.248.86.193:8080','101.109.148.121:8080','124.122.100.135:8213','104.248.8.101:8080','104.244.75.26:8080','185.204.116.171:3128','183.89.112.141:8080','185.204.202.199:8080','181.176.187.133:80','185.199.84.161:53281','183.88.78.220:8080','185.46.108.210:8080','185.11.150.244:3128','188.226.141.127:3128','188.166.119.186:80','188.166.83.13:3128','185.242.180.81:3128','188.226.141.211:8080','188.226.141.211:3128','188.166.83.20:8080','185.25.48.215:55960','192.241.245.207:8080','188.166.83.13:8080','188.226.141.61:3128','192.241.245.207:3128','188.166.83.34:8080','185.80.130.73:80','195.123.212.199:39178','198.98.54.241:8080','192.81.223.236:3128','206.189.229.46:3128','188.166.83.17:3128','195.154.67.61:3128','188.166.83.17:8080','206.189.192.5:8080','188.166.83.20:3128','206.189.200.179:8080','195.154.194.149:3128','207.154.231.211:8080','195.175.209.194:8080','212.115.108.247:8080','207.154.231.216:3128','138.197.157.32:8080','138.68.173.29:3128','138.197.136.78:3128','109.74.143.45:36529','138.197.104.219:8080','138.197.136.78:80','109.226.52.213:8080','110.168.213.8:8213','207.154.200.199:3128','212.180.196.131:36829','198.199.120.102:3128','207.154.231.211:3128','188.166.83.34:3128','34.90.113.143:3128','217.119.171.126:36090','185.20.216.101:8080','142.93.130.169:8118','163.172.136.226:8811','138.197.145.103:8080','138.197.104.219:3128','138.68.161.14:3128','138.68.165.154:3128','138.197.145.103:3128','213.251.226.17:3128','213.183.51.172:3128','207.154.231.217:3128','212.180.196.130:36829','188.225.9.121:8080','37.52.11.12:42180','46.4.96.137:8080','148.63.43.12:8080','163.172.147.94:8811','138.197.157.32:3128','138.201.72.117:80','144.217.163.138:3128','142.93.165.82:8080','138.68.165.154:8080','185.26.219.34:43328','23.237.173.102:3128','45.137.150.161:8080','213.182.158.222:80','212.47.234.231:80','188.226.141.127:8080','51.158.123.35:8811','52.233.190.21:80','151.80.199.89:3128','167.172.140.184:3128','138.197.157.44:8080','143.225.151.35:3128','162.243.107.120:8080','157.245.86.42:8080','163.172.169.167:3129','188.226.141.61:8080','34.240.97.171:3128','46.235.53.26:3128','217.65.5.113:3128','51.158.98.121:8811','206.189.177.191:8080','51.158.68.68:8811','67.205.149.230:3128','159.203.87.130:3128','167.71.138.113:8080','138.68.173.29:8080','144.217.163.138:8080','165.227.215.62:3128','159.203.44.177:3128','164.132.148.184:8118','194.167.44.91:80','41.111.137.218:8080','5.189.133.231:80','46.4.96.137:3128','67.205.132.241:8080','207.154.231.213:8080','61.90.104.206:8213','81.162.67.209:8080','162.243.108.141:8080','176.53.2.122:8080','163.172.169.167:3128','157.245.86.42:3128','167.172.225.187:80','159.89.235.196:8080','167.172.224.108:3128','198.199.120.102:8080','5.9.143.59:3128','51.15.166.107:3128','52.157.177.98:80','67.205.149.230:8080','207.154.231.216:8080','62.173.145.48:3128','95.133.163.98:61821','163.172.152.52:8811','176.9.119.170:3128','163.172.219.130:443','162.243.107.120:3128','176.62.182.29:58350','162.243.108.141:3128','173.212.202.65:80','207.154.231.213:3128','51.158.120.84:8811','51.158.119.88:8811','54.174.149.97:80','78.41.53.39:8080','207.180.223.239:80','78.228.165.215:80','95.85.36.236:3128','163.172.189.32:8811','165.227.215.71:3128','162.243.64.151:3128','165.227.215.71:8080','173.249.35.163:1448','207.154.231.217:8080','51.158.68.133:8811','62.159.156.142:80','67.205.132.241:3128','82.196.11.105:8080','213.33.157.204:44139','165.227.215.62:8080','95.85.36.236:8080','176.111.73.57:8081','165.227.220.35:3128','78.85.24.79:80','173.249.35.163:10010','178.62.236.132:8080','212.115.108.247:3128','54.208.83.109:80','62.33.207.202:80','67.205.146.29:3128','83.29.184.39:8080','217.19.209.253:8080','167.172.224.108:8080','178.62.193.19:3128','176.9.75.42:8080','81.24.90.228:41258','173.249.35.163:10020','34.73.123.161:8080','62.182.114.164:43286','67.205.174.209:3128','67.205.146.29:8080','167.172.224.108:80','217.72.1.254:41239','178.62.193.19:8080','178.62.232.215:8080','82.196.11.105:3128','176.120.60.43:8080','83.43.159.75:8080','45.82.136.195:8080','62.210.203.105:3128','80.241.222.137:80','78.47.176.200:8080','167.71.132.188:8080','51.158.111.242:8811','91.144.167.217:8080','85.237.46.168:45490','46.119.215.98:8080','171.99.202.247:8213','51.68.141.240:3128','91.205.174.26:80','83.239.97.26:36703','94.41.46.145:8080','62.33.207.202:3128','86.100.72.118:31121','5.53.16.202:3128','176.123.61.238:3128','67.205.174.209:8080','91.219.56.221:8080','85.26.146.169:80','84.22.59.74:8080','88.198.24.108:3128','176.9.119.170:8080','80.24.113.181:8088','92.222.180.156:8080','51.158.106.54:8811','88.198.24.108:8080','88.87.81.217:39413','91.236.239.149:3128','95.211.184.141:8118','51.158.108.135:8811','88.198.50.103:8080','89.140.125.17:80','93.190.253.50:80','89.251.70.153:43716','91.134.221.168:80','94.130.92.52:3128','51.158.111.229:8811','95.71.53.117:8080','91.77.162.117:8080','92.247.148.126:8080','51.158.68.26:8811','51.158.99.51:8811','51.75.71.163:3128','77.73.241.154:80','80.241.222.138:80','82.117.215.14:80','87.249.22.114:8080','88.198.50.103:3128','138.68.161.14:8080','139.59.169.246:3128','139.59.169.246:8080','142.93.38.121:80','157.245.67.128:8080','159.65.95.233:8080','159.89.16.64:3128','162.243.108.129:3128','162.243.108.161:3128','162.243.108.161:8080','167.172.225.187:8080','167.99.85.83:8080','174.138.54.49:3128','174.138.54.49:8080','176.9.75.42:3128']

path = '/home/pc/Desktop/thread/result'
def scrap_Google(sup,inf,pro):
    res = []
    mydict = []
    files = []
    missing = []
    errors = []
    missing = []

    # reading all the ids from de CSV
    with open('celeb.csv', mode='r') as infile:
        reader = csv.reader(infile)
        mydict = {int(rows[0]):rows[1] for rows in reader}

    # Listing all the files in the dir
    for r, d, f in os.walk(path):
        for file in f:
            file = file.split('.')
            file = file[0]
            files.append(file)

    #checking those who miss
    for i in range(30000):
        if not (str(i) in files):
            missing.append(i)
    print('Size of missing',len(missing))

    ## scrapping only missing
    for key in mydict.items():
        change = False
        id2 = key[0]
        name = key[1]
        if ((str(id2) in missing) and (id2 >= sup) and (id2 < inf)):

            logging.debug('ID: ' + str(key[0]))
            keyword = name +  " musician"
            if change:
                #changing proxy if it fails
                r = random.random(0,len(profinal))
                if len(profinal)>50:
                    profinal.remove(pro)
                pro = profinal[r]
            arguments = {"keywords": keyword,"limit":1,"print_urls":False,"aspect_ratio":"square","proxy":pro}  
            try: 
                change = False
                a,b = response.download(arguments)
                lis = [v for k,v in a.items()]
                oldPath = lis[0][0]
                os.rename(oldPath, "/home/pc/Desktop/threading/result/"+str(id2)+".jpg") 
                st = oldPath
                st = st.split('/')
                folder = st[len(st)-2]
                #shutil.rmtree('/home/pc/Desktop/work2/downloads/' + folder)
                continue
            except:
                change = True
                logging.debug('ERROR ID: ' + str(id2))
                errors.append(id2)
                continue
    try:
        f = open("erros.txt", "a")
        g = open("finish.txt", "a")
        f.write(str(errors))
        g.write("thread: " + str(sup) + "-" + str(inf) + "finished")
        f.close()
        g.close()
        logging.debug('FINISHED THREAD SCRAPPING')
    except:
        logging.debug('erro gravado em ficeiro')
        

for i in range(NUM_THREADS):
    inf = 300*i
    sup = inf+300  
    t = threading.Thread(name='t'+str(i),target=scrap_Google, args=(inf,sup,profinal[i]))
    t.start()